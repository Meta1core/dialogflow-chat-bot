<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-migrate-1.4.1.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>User Chat</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="style/style.css" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.concat.min.js"></script>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
</head>

<body>
<div onclick="openForm()" id="chat-circle" class="btn btn-raised">
    <div id="chat-overlay"></div>
    <i class="material-icons">speaker_phone</i>
</div>
<section id = "mainForm" class="avenue-messenger">
    <div class="menu">
        <div class="items"><span>
     <a href="#" onclick="closeForm()"  title="Minimize">&mdash;</a><br>
            <!--
                 <a href="">enter email</a><br>
                 <a href="">email transcript</a><br>-->
     <a href="#" onclick="closeForm()" title="End Chat">&#10005;</a>

     </span></div>
        <div class="button">...</div>
    </div>
    <div class="agent-face">
        <div class="half">
            <img class="agent circle" src="https://cui.tools/wp-content/uploads/2019/02/dialogflow01.png" alt="Dialogflow"></div>
    </div>
    <div class="chat" >
        <div class="chat-title">
            <h1>Бот лицея номер 1</h1>
            <h2>Powered by Dialogflow</h2>
            <!--  <figure class="avatar">
                <img src="http://askavenue.com/img/17.jpg" /></figure>-->
        </div>
        <div class="messages" id = "msssg" style ="overflow-y: scroll;">
            <div class="messages-content" ></div>

        </div>
        <div class="message-box">
            <textarea id = "m" type="text" class="message-input" placeholder="Введите сообщение..."></textarea>
            <button id="start-btn" class="message-submit "><span id = "mic" class="material-icons">mic</span></button>
        </div>
    </div>
    <div class="bg"></div>
    <script src="https://code.responsivevoice.org/responsivevoice.js?key=JJKUw1nk"></script>
</body>

<script>
    var textToSpeech = false;
    var socket = io('/', function () {
        startRecording.disabled = false;
    });

    function OnOff(){
        if(textToSpeech){
            textToSpeech = false;
            alert("Озвучка сообщений выключена!")
        } else {
            textToSpeech = true;
            alert("Озвучка сообщений включена!")
        }
    }

    var $messages = $('.messages-content'),
        d, h, m,
        i = 0;

    $(window).load(function() {
        $messages.mCustomScrollbar();
    });

    function updateScrollbar() {
        $("#msssg").animate({ scrollTop: $('#msssg')[0].scrollHeight}, 1000);
        console.log("Scroll is activated");
    }


    function setDate(){
        d = new Date()
        if (m != d.getMinutes()) {
            m = d.getMinutes();
            $('<div class="timestamp">' + d.getHours() + ':' + m + '</div>').appendTo($('.message:last'));
            $('<div class="checkmark-sent-delivered">&check;</div>').appendTo($('.message:last'));
            $('<div class="checkmark-read">&check;</div>').appendTo($('.message:last'));
        }
    }

    function insertMessage() {
        msg = $('.message-input').val();
        socket.emit('customer message', msg);
        if ($.trim(msg) == '') {
            return false;
        }
        $('<div class="message message-personal">' + msg + '</div>').appendTo($('.mCSB_container')).addClass('new');
        setDate();
        $('.message-input').val(null);
    }

    $(window).on('keydown', function(e) {
        if (e.which == 13) {
            insertMessage();
            updateScrollbar();
            return false;
        }
    })


    socket.on('customer message', function(msg) {
        $('<div class="message loading new"><figure class="avatar"><img src="https://cui.tools/wp-content/uploads/2019/02/dialogflow01.png" /></figure><span></span></div>').appendTo($('.mCSB_container'));
        setTimeout(function() {
            $('.message.loading').remove();
            $('<div class="message new"><figure class="avatar"><img src="https://cui.tools/wp-content/uploads/2019/02/dialogflow01.png" /></figure>' + msg + '</div>').appendTo($('.mCSB_container')).addClass('new');
            updateScrollbar();
            setDate();
            i++;
        }, 1000 + (Math.random() * 20) * 100);
        updateScrollbar();
        setTimeout(function () {
            if(textToSpeech) {
                responsiveVoice.speak(msg, "Russian Female");
            }
        }, 1000 + (Math.random() * 20) * 100);
    });

    $('.button').click(function(){
        $('.menu .items span').toggleClass('active');
        $('.menu .button').toggleClass('active');
    });

            //Speech to text ------------------------------------------------------------------------------
            var SpeechRecognition = window.webkitSpeechRecognition;
            var lastDebounceTranscript = "";
            var recognition = new webkitSpeechRecognition() || new SpeechRecognition();
            recognition.maxAlternatives = 1;
            recognition.interimResults = false;
            var Textbox = $('#m');
            var instructions = $('instructions');
            var Content = '';

            recognition.continuous = true;

            recognition.onresult = function(event) {
                var current = event.resultIndex;
                let result = event.results[current];
                let isFinal = result.isFinal && (result[0].confidence > 0);

                if (isFinal) {
                    var transcript = event.results[current][0].transcript;

                    if(transcript == lastDebounceTranscript) {
                        return;
                    }
                    Content += transcript;
                    Textbox.val(Content);
                    insertMessage();
                    Content = "";
                    recognition.stop();
                }
            };

            recognition.onstart = function() {
                instructions.text('Voice recognition is ON.');
            }

            recognition.onerror = function(event) {
                if(event.error == 'no-speech') {
                    instructions.text('Try again.');
                }
            }
            $('#start-btn').on('click', function(e) {
                if (Content.length) {
                    Content += ' ';
                }
                recognition.start();
            });
            //end

    function openForm() {
        document.getElementById("mainForm").style.display = "block";
    }

    function closeForm() {
        document.getElementById("mainForm").style.display = "none";
    }
</script>

</html>