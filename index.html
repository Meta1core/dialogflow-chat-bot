<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-migrate-1.4.1.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>User Chat</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="style/style.css" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.concat.min.js"></script>

    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
</head>

<body>
<div onclick="openForm()" id="chat-circle" class="btn btn-raised">
    <div id="chat-overlay"></div>
    <i class="material-icons">speaker_phone</i>
</div>
<section id = "mainForm" class="avenue-messenger">
    <div class="menu">
        <div class="items"><span>
     <a href="#" onclick="closeForm()"  title="Minimize">&mdash;</a><br>
            <!--
                 <a href="">enter email</a><br>
                 <a href="">email transcript</a><br>-->
     <a href="#" onclick="closeForm()" title="End Chat">&#10005;</a>

     </span></div>
        <div class="button">...</div>
    </div>
    <div class="agent-face">
        <div class="half">
            <img class="agent circle" src="http://askavenue.com/img/17.jpg" alt="Jesse Tino"></div>
    </div>
    <div class="chat" >
        <div class="chat-title">
            <h1>Jesse Tino</h1>
            <h2>RE/MAX</h2>
            <!--  <figure class="avatar">
                <img src="http://askavenue.com/img/17.jpg" /></figure>-->
        </div>
        <div class="messages" style ="overflow-y: scroll;">
            <div class="messages-content"></div>

        </div>
        <div class="message-box">
            <textarea type="text" class="message-input" placeholder="Type message..."></textarea>
            <button type="submit" class="message-submit">Send</button>
        </div>
    </div>
    <div class="bg"></div>
    <script src="https://code.responsivevoice.org/responsivevoice.js?key=JJKUw1nk"></script>
</body>

<script>

    var textToSpeech = false;
    var socket = io('/customer', function () {
        startRecording.disabled = false;
    });

    function OnOff(){
        if(textToSpeech){
            textToSpeech = false;
            alert("Озвучка сообщений выключена!")
        } else {
            textToSpeech = true;
            alert("Озвучка сообщений включена!")
        }
    }

    var $messages = $('.messages-content'),
        d, h, m,
        i = 0;

    $(window).load(function() {
        $messages.mCustomScrollbar();
    });


    function updateScrollbar() {
        $messages.mCustomScrollbar("update").mCustomScrollbar('scrollTo', 'bottom', {
            scrollInertia: 10,
            timeout: 0
        });
    }

    function setDate(){
        d = new Date()
        if (m != d.getMinutes()) {
            m = d.getMinutes();
            $('<div class="timestamp">' + d.getHours() + ':' + m + '</div>').appendTo($('.message:last'));
            $('<div class="checkmark-sent-delivered">&check;</div>').appendTo($('.message:last'));
            $('<div class="checkmark-read">&check;</div>').appendTo($('.message:last'));
        }
    }

    function insertMessage() {
        msg = $('.message-input').val();
        socket.emit('customer message', msg);
        if ($.trim(msg) == '') {
            return false;
        }
        $('<div class="message message-personal">' + msg + '</div>').appendTo($('.mCSB_container')).addClass('new');
        setDate();
        $('.message-input').val(null);
        updateScrollbar();
    }

    $('.message-submit').click(function() {
        insertMessage();
    });

    $(window).on('keydown', function(e) {
        if (e.which == 13) {
            insertMessage();
            return false;
        }
    })


    socket.on('customer message', function(msg) {
        $('<div class="message loading new"><figure class="avatar"><img src="http://askavenue.com/img/17.jpg" /></figure><span></span></div>').appendTo($('.mCSB_container'));
        updateScrollbar();

        setTimeout(function() {
            $('.message.loading').remove();
            $('<div class="message new"><figure class="avatar"><img src="http://askavenue.com/img/17.jpg" /></figure>' + msg + '</div>').appendTo($('.mCSB_container')).addClass('new');
            setDate();
            updateScrollbar();
            i++;
        }, 1000 + (Math.random() * 20) * 100);
        setTimeout(function () {
            if(textToSpeech) {
                responsiveVoice.speak(msg, "Russian Female");
            }
        }, 1000 + (Math.random() * 20) * 100);
        updateScrollbar();
    });
    $('.button').click(function(){
        $('.menu .items span').toggleClass('active');
        $('.menu .button').toggleClass('active');
    });



            // When the form is submitted, send a customer message to the server
            $('form').submit(function(){
                var messageText = $('#m').val();
                $('#messages').append($('<li class="customer-message">').text(messageText));
                socket.emit('customer message', messageText);
                $('#m').val('');
                return false;
            });
            // When we receive a customer message, display it

            socket.on('system error', function(error) {
                var errorText = error.type + ' - ' + error.message;
                console.log(errorText);
                $('#messages').append($('<li class="customer-error">').text(errorText));
            });


            //Speech to text ------------------------------------------------------------------------------
            var SpeechRecognition = window.webkitSpeechRecognition;

            var recognition = new webkitSpeechRecognition() || new SpeechRecognition();

            var Textbox = $('#m');
            var btn = $('#btn');
            var instructions = $('instructions');

            var Content = '';

            recognition.continuous = true;

            recognition.onresult = function(event) {

                var current = event.resultIndex;

                var transcript = event.results[current][0].transcript;
                Content += transcript;
                Textbox.val(Content);
                btn.click();
                Content = "";
                recognition.stop();
            };

            recognition.onstart = function() {
                instructions.text('Voice recognition is ON.');
            }

            recognition.onerror = function(event) {
                if(event.error == 'no-speech') {
                    instructions.text('Try again.');
                }
            }
            $('#start-btn').on('click', function(e) {
                if (Content.length) {
                    Content += ' ';
                }
                recognition.start();
            });
            //end

    function openForm() {
        document.getElementById("mainForm").style.display = "block";
    }

    function closeForm() {
        document.getElementById("mainForm").style.display = "none";
    }
</script>

</html>